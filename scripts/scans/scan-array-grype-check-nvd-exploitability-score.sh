#!/bin/bash
set -euo pipefail

images=(
  "cgr.dev/chainguard-private/prometheus-redis-exporter:1.50"
)

# Fill in with your API Key 
nvd_api_key=""
nvd_base_url="https://services.nvd.nist.gov/rest/json/cves/2.0"
out_dir="nvd"
mkdir -p "$out_dir"

# ---- Helper: sanitize a string for filenames ----
sanitize() {
  echo "$1" | tr '/:@' '___' | tr -cd 'A-Za-z0-9._-'
}

for image in "${images[@]}"; do
  # Ensure tag
  [[ "$image" != *:* ]] && image="${image}:latest"

  echo ""
  echo "Scanning image: $image"

  # Pull (fail on error)
  docker pull "$image" >/dev/null

  # Save grype JSON
  img_tag_sane="$(sanitize "$image")"
  grype_json_path="${out_dir}/grype_${img_tag_sane}.json"

  echo "-> Running grype and saving JSON: ${grype_json_path}"
  grype_json="$(grype "$image" -o json 2>/dev/null || true)"
  echo "${grype_json}" > "${grype_json_path}"

  # Extract unique CVE IDs from both vulnerability.id and relatedVulnerabilities[].id
  mapfile -t cves < <(echo "${grype_json}" | jq -r '
    (.matches[]? | ( [ .vulnerability.id ] + ( .relatedVulnerabilities // [] | map(.id) ) )[]) 
    | select(startswith("CVE-"))
  ' | sort -u)

  if [[ ${#cves[@]} -eq 0 ]]; then
    echo "-> No CVEs found in grype results."
    continue
  fi

  echo "-> Found ${#cves[@]} unique CVE(s). Fetching NVD JSONâ€¦"

  for cve in "${cves[@]}"; do
    
    if [[ "$cve" == CVE-* ]]; then
        mkdir -p "$out_dir/cves"
        api_url="$nvd_base_url?cveId=$cve"
        http_code=$(curl -sS -H "Accept: application/json" -H "apiKey: $nvd_api_key" -o "$out_dir/cves/$cve.json" -w "%{http_code}" "$api_url")
        if [[ "$http_code" -ne 200 ]]; then
            echo "NVD request failed (HTTP $http_code) for $api_url"
            exit 1
        fi
        nvdexploitabilityScore=$(cat "$out_dir/cves/$cve.json" | jq '.vulnerabilities[].cve.metrics.cvssMetricV31[].exploitabilityScore')
        echo "CVE=$cve explitabilityScore=$nvdexploitabilityScore"
    fi
  done
done

echo ""
echo "Done. Outputs saved under: ${out_dir}/"
